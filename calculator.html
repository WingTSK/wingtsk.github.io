<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale1.0">
  <title>ドロー確率計算機 (Prototype)｜WingTSK's Project</title>
</head>
<body>
<style>
  
table{
  width: max-content;
}
#esc_table > th,td{
  width: 200px;
  height: 60px;
  vertical-align: middle;
  padding: 0 4px;
  border: 1px solid #ccc;
}
.fixed00,
.fixed01,
.fixed02{
  position: sticky;
  top: 0;
  left: 0;
  /*color: #fff;*/
  background: #fff;
  &:before{
    content: "";
    position: absolute;
    top: -1px;
    left: -1px;
    width: 100%;
    height: 100%;
    border: 1px solid #ccc;
  }
}
#esc_table > th,td:has(> .condition_n:in-range){
    border: 1px solid #64d8cc;
}
.fixed00{
  z-index: 2;
}
.fixed01{
  z-index: 3;
}
.fixed02{
  z-index: 1;
}
.condition_m{
  width: 198px;
}
.namebox{
  width: 192px;
}
  .chkbox > input{
  display: none;
}
.chkcontent{
    display: none;
    border: 1px solid #64d8cc;
    margin: 2px;
    position: relative;
/*  z-index: 0;  */
    background-color: #eee;
}
  #checkbox1:checked ~ #chkcontent1{
  display: block;
}
#checkbox2:checked ~ #chkcontent2{
  display: block;
}
footer, footer > * {
  font-size: small;
  text-align: center;
}
 
</style>
<script>
  let rows_counter = [];
  let cols_counter = [];

function insertRow(id) {
  let table = document.getElementById(id);
  let cell_len = table.rows[0].cells.length;
  let row = table.insertRow(-1);
  let cell0 = row.insertCell(-1);
  let r = 1;
  if (rows_counter.length > 0){
    r = rows_counter[rows_counter.length - 1] + 1;
  }
  rows_counter.push(r);
  cell0.className = "fixed02";
  let button = '<input type="button" value="条件削除" onclick="deleteRow(this,'+r+')" /><br>条件'+String(r)+'：<a class="row_result"></a>';
  cell0.innerHTML = button;
  for (let i = 1 ; i < cell_len; i++){
    window["cell" + i] = row.insertCell(-1);
    window["cell" + i].innerHTML = '<input type="number" class="condition_n" name="condition_n_'
      + String(r) + '_' + String(cols_counter[i - 1]) + '" size="15" placeholder="枚数" min="0" max="255" onclick="this.select();">枚<br><select class="condition_m" name="condition_m_'
      + String(r) + '_' + String(cols_counter[i - 1]) + '" size="1"><option disabled selected value>－－－－</option><option selected value="0">以上ドロー</option><option value="1">ちょうどドロー</option><option value="2">以上デッキに残す</option><option value="3">ちょうどデッキに残す</option></select>';
  }
}
function deleteRow(obj,r){
  tr = obj.parentNode.parentNode;
  tr.parentNode.deleteRow(tr.sectionRowIndex);
  rows_counter.splice(rows_counter.indexOf(r),1);
}
function insertColumn(id){
  let table = document.getElementById(id);
  let rows = table.rows.length;
  let cell = table.rows[0].insertCell(-1);
  let cols = table.rows[0].cells.length;
  let c = 1;
  if (cols_counter.length > 0){
    c = cols_counter[cols_counter.length - 1] + 1;
  }
  cols_counter.push(c);
  cell.className = "fixed02";
  cell.innerHTML = '<input type="button" value="カード削除" onclick="deleteColumn(\'esc_table\','+String(c)+')">';
  cell = table.rows[1].insertCell(-1);
  cell.className = "fixed02";
  cols = table.rows[1].cells.length;
  cell.innerHTML = '<input type="text" class="cardname" name="name_'+String(c)+'" placeholder="カード名"　size="20" value="カード'+String(c)+'"><br><label>／<input type="number" name="group_'+String(c)+'" class="cardnum" size="15" placeholder="投入枚数" min="0" max="255" onclick="this.select();">枚</label>'
  for (let i = 2; i < rows; i++){
    cell = table.rows[i].insertCell(-1);
    cols = table.rows[i].cells.length;
    cell.innerHTML = '<input type="number" class="condition_n" name="condition_n_'
      + String(rows_counter[i - 2]) + '_' + String(c) + '" size="15" placeholder="枚数" min="0" max="255" onclick="this.select();">枚<br><select class="condition_m" name="condition_m_'
      + String(rows_counter[i - 2]) + '_' + String(c) + '" size="1"><option disabled selected value>▼▼ モード ▼▼</option><option selected value="0">以上ドロー</option><option value="1">ちょうどドロー</option><option value="2">以上デッキに残す</option><option value="3">ちょうどデッキに残す</option></select>';
  }
}
function deleteColumn(id,n){
  let table = document.getElementById(id);
  let rows = table.rows.length;
  let tc = cols_counter.indexOf(n) + 1;
  for (let i = 0; i < rows; i++){
    let cols = table.rows[i].cells.length;
    table.rows[i].deleteCell(tc);
  }
  cols_counter.splice(cols_counter.indexOf(n),1);
}
function makeMultiHandPat(d, h, g, pt){
  if (typeof(g) == "number"){
    g = [g];
  }
  let p = [];
  let n = 0;
  for (let i = 0; i < g.length; i++){
    p[i] = 0;
  }
  let c = multiDCombination(d, h, g, p, n, pt);
  return c;
}
function multiDCombination(d, h, g, p, n, pt){
  let a = [];
  let dg = d - sumArray(g);
  for (p[n]=0; p[n] <= g[n]; p[n]++){
    let v = 1;
    if (p.length > n + 1){
      a.push(multiDCombination(d, h, g, p, n + 1, pt))
    }else{
      let poi = sumArray(p);
      if (h >= poi){
        for (let j = 0; j < p.length; j++){
          v = v * combination_pt(g[j], p[j], pt);
        }
        v = v * combination_pt(dg, h - poi, pt);
      }else{
        v = 0;
      }
      a.push(v);
    }
  }
  return a;
}
function sumArray(ary){
  let s = 0;
  for (let i = 0; i < ary.length; i++){
      s = s + ary[i];
  }
  return s;
}
function combination(n, r){
  if (n >= r && r >= 0){
    let k = Math.min(r, n - r);
    let c = 1;
    for (let i = 0; i < k; i++){
      c = c * (n - i) / (1 + i);
    }
    return c;
  }else{
    return 0;
  }
}
function pascal_triangle(n){
  let a = [];
  for (i = 0; i <= n; i++){
    let b = [];
    for (j = 0; j <= i; j++){
      if (i == 0 || j == 0){
        b.push(1);
      }else{
        if (j == i){
          b.push(a[i - 1][j - 1]);
        }else{
          b.push(a[i - 1][j - 1] + a[i - 1][j]);
        }
      }
    }
    a.push(b);
  }
  return a;
}
function combination_pt(n, r, pt){
  if (n < r){
    return 0;
  }else{
    let k = Math.min(r, n - r);
    return pt[n][k];
  }
}
function chkMultiHandPat(m, h, g, c){
  let n = 0;
  let p = [];
  for (let i = 0; i < g.length; i++){
    p[i] = 0;
  }
  return chkMDC(m, h, g, c, p, n);
}
function chkMDC(m, h, g, c, p, n){
  let r = 0;
  for (p[n] = 0; p[n] <= g[n]; p[n]++){
    if (n < p.length - 1){
      r = r + chkMDC(m, h, g, c, p, n + 1);
    }else{
      if (sumArray(p) <= h){
        if (ccMDC(m, g, c, p) == 1){
          r = r + multiAryV(m, p, 0);
        }
      }
    }
  }
  return r;
}
function ccMDC(m, g, c0, p){
  let l = c0.length;
  let t = 1;
  let tc = 0;
  let cx = c0[l - 1].slice();
  if (l > 1){
    let c1 = c0.slice();
    c1.length = l - 1;
    tc = ccMDC(m, g, c1, p);
  }
  if (tc == 0){
    for (let i = 0; i < cx.length; i++){
      if (p[i] < cx[i][0] || p[i] > cx[i][1]){
        t = 0
      }
    }
  }
  return t;
}
function multiAryV(m, p, n){
  let v = 0;
  if (n < p.length - 1){
    v = multiAryV(m[p[n]], p, n+1);
  }else{
    v = m[p[n]];
  }
  return v;
}
function makecondition(g){
      let c = [];
      for (let i = 0; i < rows_counter.length; i++){
        let con =[];
        for (let j = 0; j < cols_counter.length; j++){
          let strn = '[name="condition_n_' + String(rows_counter[i]) + '_' + String(cols_counter[j]) + '"]';
          let strm = '[name="condition_m_' + String(rows_counter[i]) + '_' + String(cols_counter[j]) + '"]';
          let numc = document.querySelector(strn).value;
          let mode = document.querySelector(strm).value;
          let numg = g[j];
          if (mode == "0"){
           let ca =[];
            ca.push(Number(numc));
            ca.push(numg);
            con.push(ca);
          }else if (mode == "1"){
            let ca =[];
            ca.push(Number(numc));
            ca.push(Number(numc));
            con.push(ca);
          }else if (mode == "2"){
            let ca =[];
            ca.push(0);
            ca.push(numg - Number(numc));
            con.push(ca);
          }else if (mode == "3"){
            let ca =[];
            ca.push(numg - Number(numc));
            ca.push(numg - Number(numc));
            con.push(ca);
          }else{
            let ca =[];
            ca.push(0);
            ca.push(numg);
            con.push(ca);
          }
        }
        c.push(con);
      }
  return c;
}
function printES_calc(){
  if (rows_counter.length && cols_counter.length){
    let deck = Number(document.querySelector('[name="deck"]').value);
    let hand = Number(document.querySelector('[name="hand"]').value);
    let group = [];
    let pt = pascal_triangle(deck);
    for (let j = 0; j < cols_counter.length; j++){
      let str = '[name="group_' + String(cols_counter[j]) + '"]';
      group.push(Number(document.querySelector(str).value));
    }
    if (sumArray(group) <= deck && hand <= deck){
      let multi = makeMultiHandPat(deck, hand, group, pt);
      let condition = makecondition(group);
      let result = chkMultiHandPat(multi, hand, group, condition);
      document.querySelector('[id="output"]').innerText = "計算結果："+String(Math.round(result/combination_pt(deck,hand,pt)*1000000)/10000)+"％\n("+result+"／"+combination_pt(deck,hand,pt)+"通り)";
      let cl = condition.length;
      for (let k = 0; k < cl; k++){
        let scon = [];
        scon.push(condition[k]);
        document.querySelectorAll(".row_result")[k].innerText = String(Math.round(chkMultiHandPat(multi, hand, group, scon)/combination_pt(deck,hand,pt)*1000000)/10000)+"％";
      }
    }else{
      let err = "";
      if (hand > deck){
        err = "エラー：手札枚数がデッキ枚数を超えています。\n";
      }
      if (sumArray(group) > deck){
        err = "エラー：登録カードの合計枚数がデッキ枚数を超えています。\n";
      }
      document.querySelector('[id="output"]').innerText = err;
    }
  }else{
    let err = "";
    if (!(rows_counter.length)){
      err = "エラー：条件が登録されていません。\n";
    }
    if (!(cols_counter.length)){
      err = "エラー：カードが登録されていません。\n";
    }
    document.querySelector('[id="output"]').innerText = err;
  }
}
function printES_clear(){
  let rows = rows_counter.length;
  let cols = cols_counter.length;
  for (let i = 0; i < rows; i++){
    let obj = document.querySelector("#esc_table > tbody:nth-child(1) > tr:nth-child(3) > td:nth-child(1) > input");
    deleteRow(obj,rows_counter[i]);
  }
  for (let i = cols - 1; i >= 0; i--){
    deleteColumn("esc_table",cols_counter[i]);
  }
  insertRow('esc_table');
  insertColumn('esc_table');
  document.querySelector("#output").innerText = "条件を設定してください";
}
function condition_export(){
  
}
</script>
  <h2>ドロー確率計算機 (Prototype)</h2>
  <p>遊戯王OCGなどのカードゲームで、特定のカードや組み合わせをドローできる確率を計算できる計算機です。<br>条件が複数ある場合にも対応しています。</p>
  <div class="chkmenu">
    <input type="checkbox" id="checkbox1" style="display: none;"><label for="checkbox1">▼▽使い方（クリックで展開）▽▼</label>
    <div class="chkcontent" id="chkcontent1">
    「デッキ枚数：」の入力欄には、確率を計算したいデッキ（山札）の枚数を、「手札枚数：」の入力欄には、引いている手札の枚数を入力します。<br>
    例えば、「40枚デッキから5枚引いた場合」の確率を計算したい場合、「デッキ枚数：」には「40」、「手札枚数：」には「5」と、それぞれ入力してください。<br><br>
    「条件登録:」の入力欄では、カード名、デッキ投入枚数、確率を計算したい条件を入力します。<br>
    「カード名」と「投入枚数」の入力欄には、カード名と、そのカードをデッキに投入している枚数を入力します。<br><br>
    「条件：」には、確率を計算したい手札の条件を入力します。<br>
    （条件の詳しい入力方法については、下の「条件について」をご確認ください。）<br>
    「カード追加」ボタンや「条件追加」ボタンで、カードや条件の追加を行う事ができます。
    </div>
  </div>
  <br>
  <div class="chkmenu">
    <input type="checkbox" id="checkbox2" style="display: none;"><label for="checkbox2">▼▽条件について（クリックで展開）▽▼</label>
    <div class="chkcontent" id="chkcontent2">
    条件は枚数と、モードを設定します。<br>
    モードは、<br>
    ・（設定枚数）以上ドロー<br>
    ・（設定枚数）ちょうどドロー<br>
    ・（設定枚数）以上デッキに残す<br>
    ・（設定枚数）ちょうどデッキに残す<br>
    これらの４種類があります。確率計算したい状況に合わせて設定してください。<br><br>
    また、一つの条件（同じ行）に複数カードの条件を設定した場合、それぞれを同時に満たす確率を計算します。<br>
    例１：【条件１】に"「カード１」を１枚以上ドロー"と"「カード２」を１枚ちょうどドロー"を、それぞれ設定した場合<br>
    ⇒「カード１」を１枚以上ドローし、かつ、「カード２」を１枚ちょうどドローする場合の確率を求めます。<br>
    （○：「カード１」を１枚ドロー、「カード２」を１枚ドローするパターン）<br>
    （×：「カード１」を２枚ドロー、「カード２」をドローしないパターン）<br><br>
    さらに、複数の条件を設定した場合、それぞれの条件のいずれかを満たす確率を計算します。<br>
    例２：【条件１】に"「カード１」を２枚以上ドロー"を、【条件２】に"「カード１」を１枚ちょうどドロー"と"「カード２」を１枚ちょうどドロー"を、それぞれ設定した場合<br>
    ⇒「カード１」を１枚以上ドローする場合、または、「カード１」と「カード２」をそれぞれ１枚ちょうどずつドローする場合、いずれか（または両方）に該当する確率を求めます。<br>
    （○：「カード１」を１枚ドロー、「カード２」を１枚ドローするパターン（条件２に該当））<br>
    （○：「カード１」を２枚ドロー、「カード２」をドローしないパターン（条件１に該当））<br>
    （×：「カード１」を１枚ドロー、「カード２」を２枚ドローするパターン）<br><br>
    このように条件を組み合わせていくことで、簡単なパターンから複雑なパターンまで計算する事ができます。<br>
    なお、あまりに複雑な条件を設定した場合、計算量が膨大になるため、時間がかかったり、最悪フリーズする可能性があります。ご了承ください。
    </div>
  </div>
  <br>
  <input type="button" value="計算!" onclick="printES_calc();">
  <br>
  <table><tbody><tr><td nowrap="">
  <a id="output">
  条件を設定してください
  </a>
  </td></tr></tbody></table>
  <br>
  <div>
    <form name="es_calculator" autocomplete="off">
    <table><tbody><tr><td>デッキ枚数:</td><td><input type="number" name="deck" id="deck_n" required="required" value="40" min="0" max="255" placeholder="デッキ枚数" onclick="this.select();">枚</td></tr>
    <tr><td>手札枚数:</td><td><input type="number" name="hand" id="hand_n" required="required" value="5" min="0" max="255" placeholder="手札枚数" onclick="this.select();">枚</td></tr></tbody></table>
    <br>
    <input type="button" value="クリア" onclick="printES_clear();">
    <div style="display: flex;">
      <div>
        <table id="esc_table">
          <tbody><tr>
            <td class="fixed00" nowrap="">条件登録:</td>
          </tr>
          <tr>
            <td class="fixed01" nowrap="">カード名<br>／デッキ投入枚数</td>
          </tr>
          </tbody>
        </table>
        <input type="button" value="条件追加" onclick="insertRow('esc_table')">
      </div>
      <div><input type="button" value="カード追加" onclick="insertColumn('esc_table')"></div>
    </div>
  </form>
  <br>
  <input type="button" value="計算!" onclick="printES_calc();">
  </div>
  <div id="output">
  </div>
  <footer>
    <hr />
    <nav id="footerrnav">
    </nav>
    &copy;WingTSK 2020
  </footer>

<script>
  insertRow('esc_table');
  insertColumn('esc_table');
</script>
</body>
</html>
